<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Buddy - Your time series metric friend</title>
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-date-fns/2.0.0/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/sql-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    
    <!-- Application Styles -->
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <!-- VS Code-like Layout -->
    <div class="vscode-container">
        <!-- Title Bar -->
        <div class="title-bar">
            <div class="title-bar-content">
                <span class="app-name">Time Buddy</span>
                <div class="title-bar-controls">
                    <span class="connection-status disconnected" id="titleBarConnectionStatus">Not Connected</span>
                    <span class="connection-status ai-disconnected" id="titleBarAiStatus">AI: Not Connected</span>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Activity Bar (Left Icons) -->
            <div class="activity-bar">
                <div class="activity-item active" data-view="connections" title="Connections & Data Sources">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
                <div class="activity-item" data-view="explorer" title="Schema Explorer">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 4H4c-1.11 0-2 .89-2 2v3h2V6h4V4zm6 0v2h4v3h2V6c0-1.11-.89-2-2-2h-4zm-6 15v2h4c1.11 0 2-.89 2-2v-3h-2v3H4v-2H2v3c0 1.11.89 2 2 2h4zm8 0h4c1.11 0 2-.89 2-2v-3h-2v3h-4v2z"/>
                    </svg>
                </div>
                <div class="activity-item" data-view="dashboards" title="Dashboard Explorer">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                    </svg>
                </div>
                <div class="activity-item" data-view="files" title="File Explorer">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                    </svg>
                </div>
                <div class="activity-item" data-view="analytics" title="AI Analytics">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 3v2.01c-2.73.51-4.89 2.67-5.4 5.4H1v2h2.6c.51 2.73 2.67 4.89 5.4 5.4V20h2v-2.01c2.73-.51 4.89-2.67 5.4-5.4H18v-2h-2.6c-.51-2.73-2.67-4.89-5.4-5.4V3H9zm1 4.07c1.65.22 2.98 1.55 3.21 3.21l.79-.79 1.41 1.41-.79.79c-.22 1.65-1.55 2.98-3.21 3.21V16h-1v-1.1c-1.65-.22-2.98-1.55-3.21-3.21L6.41 12.5 5 11.09l.79-.79C6.01 8.65 7.35 7.32 9 7.1V6h1v1.07z"/>
                    </svg>
                </div>
                <div class="activity-item" data-view="history" title="Query History">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                    </svg>
                </div>
            </div>

            <!-- Main Content Area (everything except activity bar) -->
            <div class="main-content-area">
                <!-- Horizontal Layout (sidebar + editor) -->
                <div class="horizontal-layout">
                    <!-- Side Bar (Changes based on activity selection) -->
                    <div class="sidebar">
                        <div class="sidebar-resizer"></div>
                        <!-- Connections Panel -->
                        <div class="sidebar-panel active" id="connectionsPanel">
                            <div class="sidebar-header">
                                <h3>Connections & Data Sources</h3>
                            </div>
                            <div class="sidebar-content">
                                <!-- Connections Section -->
                                <div class="section-wrapper">
                                    <div class="section-header">
                                        <h4>Connections</h4>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <button class="icon-button" onclick="exportConnections()" title="Export Connections" style="background: transparent; color: #cccccc; border: 1px solid #454545; padding: 4px 8px; border-radius: 3px; cursor: pointer; display: flex; align-items: center;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                                                </svg>
                                            </button>
                                            <button class="icon-button" onclick="importConnections()" title="Import Connections" style="background: transparent; color: #cccccc; border: 1px solid #454545; padding: 4px 8px; border-radius: 3px; cursor: pointer; display: flex; align-items: center;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
                                                </svg>
                                            </button>
                                            <button class="icon-button" onclick="showNewConnectionDialog()" title="New Connection" style="background: #007acc; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; display: flex; align-items: center;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="search-container">
                                        <input type="text" id="connectionSearch" class="search-input" placeholder="Filter connections..." oninput="filterConnections()">
                                    </div>
                                    <div class="section-scrollable">
                                        <div class="connection-list" id="connectionList">
                                            <div class="empty-state">
                                                <div style="margin-bottom: 12px; color: #858585;">No connections configured</div>
                                                <button class="primary-button" onclick="showNewConnectionDialog()" style="font-size: 12px; padding: 6px 12px;">
                                                    Add Your First Connection
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Data Sources Section -->
                                <div class="section-wrapper">
                                    <div class="section-header">
                                        <h4>Data Sources</h4>
                                        <button class="icon-button" onclick="refreshDataSources()" title="Refresh Data Sources">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="search-container">
                                        <input type="text" id="datasourceSearch" class="search-input" placeholder="Filter data sources..." oninput="filterDataSources()">
                                    </div>
                                    <div class="section-scrollable">
                                        <div class="datasource-list" id="datasourceList">
                                            <div class="empty-state">Connect to Grafana first</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Schema Explorer Panel -->
                        <div class="sidebar-panel" id="explorerPanel">
                            <div class="sidebar-header">
                                <h3>Schema Explorer</h3>
                                <button class="icon-button" onclick="refreshSchema()" title="Refresh Schema">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="sidebar-content">
                                <div class="datasource-selector-container">
                                    <select id="schemaDatasourceSelect" class="datasource-select" onchange="onSchemaDatasourceChange()">
                                        <option value="">Select a data source</option>
                                    </select>
                                </div>
                                <div id="schemaContainer">
                                    <div class="empty-state">Select a data source to explore schema</div>
                                </div>
                            </div>
                        </div>

                        <!-- Dashboard Explorer Panel -->
                        <div class="sidebar-panel" id="dashboardsPanel">
                            <div class="sidebar-header">
                                <h3>Dashboard Explorer</h3>
                            </div>
                            <div class="sidebar-content">
                                <div class="search-container">
                                    <input type="text" id="dashboardSearch" placeholder="Search dashboards..." class="search-input" onkeyup="searchDashboards()">
                                </div>
                                <div id="dashboardResults" class="dashboard-results">
                                    <div class="empty-state">Search for dashboards to explore</div>
                                </div>
                                <!-- Dashboard Queries Section -->
                                <div id="dashboardQueries" class="dashboard-queries hidden">
                                    <div class="dashboard-back">
                                        <button class="back-button" onclick="backToDashboardList()">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                                            </svg>
                                            Back to Dashboards
                                        </button>
                                    </div>
                                    <div class="dashboard-info">
                                        <h4 id="selectedDashboardTitle"></h4>
                                        <p id="selectedDashboardDescription"></p>
                                        <div id="selectedDashboardLink" class="dashboard-link-container hidden">
                                            <a id="dashboardLinkUrl" href="#" target="_blank" class="dashboard-link">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
                                                </svg>
                                                Open in Grafana
                                            </a>
                                        </div>
                                    </div>
                                    <div class="dashboard-query-list">
                                        <div class="dashboard-queries-header">
                                            <span>Panels</span>
                                        </div>
                                        <div id="dashboardQueryList" class="query-list"></div>
                                    </div>
                                    <div id="dashboardQueryPreview" class="query-preview hidden">
                                        <div class="query-preview-header">
                                            <span>Query Preview</span>
                                        </div>
                                        <div id="queryPreviewContent" class="query-preview-content"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- File Explorer Panel -->
                        <div class="sidebar-panel" id="filesPanel">
                            <div class="sidebar-header">
                                <h3>File Explorer</h3>
                                <button class="icon-button" onclick="selectQueryDirectory()" title="Open Folder">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="sidebar-content">
                                <div class="file-explorer-container">
                                    <div id="fileExplorerTree" class="file-tree">
                                        <div class="empty-state">Select a folder to explore query files</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- History Panel -->
                        <div class="sidebar-panel" id="historyPanel">
                            <div class="sidebar-header">
                                <h3>Query History</h3>
                                <button class="icon-button" onclick="clearQueryHistory()" title="Clear History">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="sidebar-content">
                                <div class="search-container">
                                    <input type="text" id="historySearch" placeholder="Search history..." class="search-input" onkeyup="History.handleSearch(this.value)">
                                </div>
                                <div id="historyList" class="history-list">
                                    <div class="empty-state">No query history yet</div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Analytics Panel -->
                        <div class="sidebar-panel" id="analyticsPanel">
                            <div class="sidebar-header">
                                <h3>AI ANALYTICS</h3>
                            </div>
                            <div class="sidebar-content">
                                <!-- AI Connections Section -->
                                <div class="section-wrapper">
                                    <div class="section-header">
                                        <h4>AI Connections</h4>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <button class="icon-button" onclick="showNewAiConnectionDialog()" title="New AI Connection" style="background: #007acc; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; display: flex; align-items: center;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="search-container">
                                        <input type="text" id="aiConnectionSearch" class="search-input" placeholder="Filter AI connections..." oninput="filterAiConnections()">
                                    </div>
                                    <div class="section-scrollable">
                                        <div class="connection-list" id="aiConnectionList">
                                            <!-- AI connections will be dynamically populated here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Data Configuration Section -->
                                <div class="section-header">
                                    <h4>DATA CONFIGURATION</h4>
                                </div>
                                
                                <div class="form-section">
                                    <div class="form-group">
                                        <label>Data Source:</label>
                                        <select id="analyticsDatasource" class="select-input" onchange="onAnalyticsDatasourceChange()">
                                            <option value="">Select data source</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Retention Policy:</label>
                                        <select id="analyticsRetentionPolicy" class="select-input">
                                            <option value="raw" selected>raw (Default)</option>
                                            <option value="autogen">autogen</option>
                                            <option value="default">default</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Measurement:</label>
                                        <select id="analyticsMeasurement" class="select-input">
                                            <option value="">Select measurement...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Field:</label>
                                        <select id="analyticsField" class="select-input">
                                            <option value="">Select field...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Time Range:</label>
                                        <select id="analyticsTimeRange" class="select-input">
                                            <option value="1h">Last 1 Hour</option>
                                            <option value="6h">Last 6 Hours</option>
                                            <option value="1d" selected>Last 1 Day</option>
                                            <option value="7d">Last 7 Days</option>
                                            <option value="30d">Last 30 Days</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Tag Filtering Section -->
                                <div class="section-header">
                                    <h4>FILTERING & GROUPING</h4>
                                </div>
                                
                                <div class="form-section">
                                    <div class="form-group">
                                        <label>Filter by Tags:</label>
                                        <div id="tagFiltersContainer">
                                            <div class="tag-filter-item">
                                                <select class="tag-key-select select-input" onchange="onTagKeyChange(this)">
                                                    <option value="">Select tag...</option>
                                                </select>
                                                <select class="tag-value-select select-input" disabled>
                                                    <option value="">Select value...</option>
                                                </select>
                                                <button type="button" class="icon-button tag-filter-remove" onclick="removeTagFilter(this)" title="Remove filter">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        <button type="button" class="secondary-button" onclick="addTagFilter()" style="margin-top: 8px;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                            </svg>
                                            Add Tag Filter
                                        </button>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Group By:</label>
                                        <div class="groupby-options">
                                            <div class="form-group">
                                                <label>
                                                    <input type="checkbox" id="groupByTime" onchange="onGroupByChange()"> 
                                                    Group by Time
                                                </label>
                                                <select id="timeGroupInterval" class="select-input" disabled>
                                                    <option value="1m">1 minute</option>
                                                    <option value="5m">5 minutes</option>
                                                    <option value="15m">15 minutes</option>
                                                    <option value="1h" selected>1 hour</option>
                                                    <option value="6h">6 hours</option>
                                                    <option value="1d">1 day</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label>
                                                    <input type="checkbox" id="groupByTags" onchange="onGroupByChange()"> 
                                                    Group by Tags
                                                </label>
                                                <select id="groupByTagsSelect" class="select-input" multiple disabled>
                                                    <option value="">No tags available</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Analysis Type Section -->
                                <div class="section-header">
                                    <h4>ANALYSIS TYPE</h4>
                                </div>
                                
                                <div class="analysis-tabs">
                                    <button class="tab-button active" data-analysis="anomaly">
                                        ⚠️ Anomaly Detection
                                    </button>
                                    <button class="tab-button" data-analysis="prediction">
                                        📈 Prediction
                                    </button>
                                    <button class="tab-button" data-analysis="trend">
                                        📊 Trend Analysis
                                    </button>
                                </div>

                                <!-- Visual Analysis Options -->
                                <div class="visual-analysis-options">
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="useVisualMode" />
                                            Visual Analysis Mode
                                        </label>
                                    </div>
                                </div>

                                    <!-- Anomaly Detection Options -->
                                    <div id="anomalyOptions" class="analysis-options active">
                                        <div class="form-group">
                                            <label>Sensitivity:</label>
                                            <select id="anomalySensitivity">
                                                <option value="low">Low (Conservative)</option>
                                                <option value="medium" selected>Medium</option>
                                                <option value="high">High (Aggressive)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Alert Threshold:</label>
                                            <input type="range" id="alertThreshold" min="0.5" max="1.0" step="0.1" value="0.8">
                                            <span id="thresholdValue">0.8</span>
                                        </div>
                                    </div>

                                    <!-- Prediction Options -->
                                    <div id="predictionOptions" class="analysis-options">
                                        <div class="form-group">
                                            <label>Forecast Horizon:</label>
                                            <select id="forecastHorizon">
                                                <option value="1h">1 Hour</option>
                                                <option value="6h">6 Hours</option>
                                                <option value="1d" selected>1 Day</option>
                                                <option value="3d">3 Days</option>
                                                <option value="7d">1 Week</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Confidence Level:</label>
                                            <select id="confidenceLevel">
                                                <option value="0.80">80%</option>
                                                <option value="0.95" selected>95%</option>
                                                <option value="0.99">99%</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Trend Analysis Options -->
                                    <div id="trendOptions" class="analysis-options">
                                        <div class="form-group">
                                            <label>Analysis Depth:</label>
                                            <select id="trendDepth">
                                                <option value="basic">Basic Trends</option>
                                                <option value="seasonal" selected>Include Seasonality</option>
                                                <option value="advanced">Advanced Patterns</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button id="runAnalysis" class="primary-button" disabled>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M8 5v14l11-7z"/>
                                        </svg>
                                        Run Analysis
                                    </button>
                                    <button id="viewSavedAnalyses" class="secondary-button" onclick="Analytics.showSavedAnalyses()">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                                        </svg>
                                        Saved Analyses
                                    </button>
                                    <button id="scheduleAnalysis" class="secondary-button" disabled>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zM12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                                        </svg>
                                        Schedule
                                    </button>
                                </div>
                            </div>

                            <!-- Analytics results now shown in modal -->
                        </div>
                    
                    <!-- Editor and Panel Area -->
                    <div class="editor-panel-area">
                        <!-- Main Editor Area -->
                        <div class="editor-area">
                            <!-- Tab Bar -->
                            <div class="tab-bar" id="tabBar">
                                <div class="tab active" data-tab-id="untitled-1">
                                    <span class="tab-label">Untitled-1</span>
                                    <button class="tab-close" onclick="closeTab('untitled-1')">×</button>
                                </div>
                                <button class="new-tab-button" title="New Query">+</button>
                            </div>

                            <!-- Tab Content -->
                            <div class="tab-content">
                                <div class="editor-container active" data-tab-id="untitled-1">
                                    <!-- Query Options Bar -->
                                    <div class="editor-toolbar">
                                        <div class="editor-options">
                                            <div class="option-group">
                                                <label>Data Source:</label>
                                                <select class="tab-datasource-select" onchange="onTabDatasourceChange()">
                                                    <option value="">Select data source</option>
                                                </select>
                                            </div>
                                            <div class="option-group">
                                                <label>From (hours ago):</label>
                                                <input type="number" id="timeFrom" value="1" min="0" step="0.1" class="small-input">
                                            </div>
                                            <div class="option-group">
                                                <label>To (hours ago):</label>
                                                <input type="number" id="timeTo" value="0" min="0" step="0.1" class="small-input">
                                            </div>
                                            <div class="option-group">
                                                <label>Interval ($__interval):</label>
                                                <select id="queryInterval" class="small-input">
                                                    <option value="15s">15s</option>
                                                    <option value="30s">30s</option>
                                                    <option value="1m" selected>1m</option>
                                                    <option value="5m">5m</option>
                                                    <option value="15m">15m</option>
                                                    <option value="30m">30m</option>
                                                    <option value="1h">1h</option>
                                                    <option value="6h">6h</option>
                                                    <option value="12h">12h</option>
                                                    <option value="1d">1d</option>
                                                </select>
                                            </div>
                                            <div class="option-group">
                                                <button class="execute-button" onclick="Interface.executeQuery('untitled-1')" disabled>
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                        <path d="M8 5v14l11-7z"/>
                                                    </svg>
                                                    Execute
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- CodeMirror Editor -->
                                    <div class="code-editor-container">
                                        <textarea id="query" placeholder="Enter your query here..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bottom Panel (Results, Variables, etc.) -->
                        <div class="panel-area">
                    <div class="panel-resizer"></div>
                    <div class="panel-tabs">
                        <div class="panel-tab active" data-panel="results">Results</div>
                        <div class="panel-tab" data-panel="variables">Variables</div>
                        <div class="panel-tab" data-panel="settings">Settings</div>
                        <button class="panel-close" onclick="togglePanel()" title="Close Panel">×</button>
                    </div>

                    <div class="panel-content">
                        <!-- Results Panel -->
                        <div class="panel-section active" id="resultsPanel">
                            <div id="results">
                                <div class="empty-state">No query executed yet</div>
                            </div>
                        </div>

                        <!-- Variables Panel -->
                        <div class="panel-section" id="variablesPanel">
                            <div id="variablesContainer">
                                <div class="empty-state">No variables defined</div>
                            </div>
                        </div>

                        <!-- Settings Panel -->
                        <div class="panel-section" id="settingsPanel">
                            <div class="settings-grid">
                                <div class="setting-group">
                                    <label for="maxDataPoints">Max Data Points</label>
                                    <input type="number" id="maxDataPoints" value="1000" min="1">
                                </div>
                                <div class="setting-group">
                                    <label for="intervalMs">Interval (ms)</label>
                                    <input type="number" id="intervalMs" value="15000" min="1000" step="1000">
                                </div>
                                <div class="setting-group">
                                    <label>
                                        <input type="checkbox" id="instantQuery">
                                        Instant Query (PromQL only)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dialogs -->
    <!-- Connection Dialog -->
    <div class="modal-overlay" id="connectionDialog">
        <div class="modal">
            <div class="modal-header">
                <h3 id="connectionDialogTitle">New Connection</h3>
                <button class="modal-close" onclick="hideConnectionDialog()">×</button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label for="connectionName">Connection Name</label>
                    <input type="text" id="connectionName" placeholder="My Grafana Server">
                </div>
                <div class="form-group">
                    <label for="connectionUrl">Grafana URL</label>
                    <input type="text" id="connectionUrl" placeholder="https://grafana.example.com">
                </div>
                <div class="form-group">
                    <label for="connectionUsername">Username</label>
                    <input type="text" id="connectionUsername" placeholder="admin">
                </div>
                <div class="form-group">
                    <label for="connectionPassword">Password</label>
                    <input type="password" id="connectionPassword" placeholder="Enter password">
                </div>
                
                <!-- SOCKS5 Proxy Section -->
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableProxy" onchange="toggleProxyFields()"> Use SOCKS5 Proxy
                    </label>
                </div>
                
                <div id="proxyFields" class="proxy-fields" style="display: none;">
                    <div class="form-group">
                        <label for="proxyHost">Proxy Host</label>
                        <input type="text" id="proxyHost" placeholder="127.0.0.1">
                    </div>
                    <div class="form-group">
                        <label for="proxyPort">Proxy Port</label>
                        <input type="number" id="proxyPort" placeholder="1080" min="1" max="65535">
                    </div>
                    <div class="form-group">
                        <label for="proxyUsername">Proxy Username (optional)</label>
                        <input type="text" id="proxyUsername" placeholder="proxy_user">
                    </div>
                    <div class="form-group">
                        <label for="proxyPassword">Proxy Password (optional)</label>
                        <input type="password" id="proxyPassword" placeholder="proxy_password">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="saveConnection()" class="primary-button">Save & Connect</button>
                <button onclick="hideConnectionDialog()" class="secondary-button">Cancel</button>
            </div>
        </div>
    </div>

    <!-- AI Connection Dialog -->
    <div class="modal-overlay" id="aiConnectionDialog">
        <div class="modal">
            <div class="modal-header">
                <h3 id="aiConnectionDialogTitle">New AI Connection</h3>
                <button class="modal-close" onclick="hideAiConnectionDialog()">×</button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label for="aiConnectionName">Connection Name</label>
                    <input type="text" id="aiConnectionName" placeholder="My Ollama Server">
                </div>
                <div class="form-group">
                    <label for="aiEndpoint">Ollama Endpoint</label>
                    <input type="text" id="aiEndpoint" placeholder="http://localhost:11434">
                </div>
                <div class="form-group">
                    <label for="aiModel">Default Model</label>
                    <select id="aiModel">
                        <option value="">Loading models...</option>
                    </select>
                </div>
                <div class="form-group" id="customModelGroup" style="display: none;">
                    <label for="customModelName">Custom Model Name</label>
                    <input type="text" id="customModelName" placeholder="Enter model name">
                </div>
                
                <!-- Advanced Settings -->
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="showAdvancedAiSettings" onchange="toggleAdvancedAiSettings()"> Advanced Settings
                    </label>
                </div>
                
                <div id="advancedAiSettings" style="display: none;">
                    <div class="form-group">
                        <label for="aiResponseTokens">Response Tokens (num_predict)</label>
                        <select id="aiResponseTokens">
                            <option value="-1" selected>Infinite (Ollama Default)</option>
                            <option value="1024">1,024</option>
                            <option value="2048">2,048</option>
                            <option value="4096">4,096</option>
                            <option value="8192">8,192</option>
                            <option value="16384">16,384</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="aiContextSize">Context Size (num_ctx)</label>
                        <select id="aiContextSize">
                            <option value="4096">4,096 (Default)</option>
                            <option value="8192">8,192 (Large)</option>
                            <option value="16384" selected>16,384 (Large Context)</option>
                            <option value="32768">32,768 (Extra Large)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="aiTimeout">Analysis Timeout (seconds)</label>
                        <select id="aiTimeout">
                            <option value="120">2 minutes (Quick)</option>
                            <option value="300">5 minutes (Standard)</option>
                            <option value="600" selected>10 minutes (Recommended)</option>
                            <option value="900">15 minutes (Large datasets)</option>
                            <option value="1800">30 minutes (Very large datasets)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="saveAiConnection()" class="primary-button">Save & Connect</button>
                <button onclick="hideAiConnectionDialog()" class="secondary-button">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Saved Analyses Modal -->
    <div class="modal-overlay" id="savedAnalysesModal" style="display: none;">
        <div class="modal" style="max-width: 800px; width: 90%; max-height: 90vh; margin: 50px auto;">
            <div class="modal-header">
                <h3>Saved AI Analyses</h3>
                <button class="modal-close" onclick="Analytics.closeSavedAnalyses()">×</button>
            </div>
            <div class="modal-content" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                <div id="savedAnalysesPanel" class="saved-analyses-panel">
                    <!-- Saved analyses will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Status -->
    <div id="authStatus" class="auth-status-toast"></div>

    <!-- Application Scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/api.js"></script>
    <script src="js/influxqlLinter.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/connections.js"></script>
    <script src="js/variables.js"></script>
    <script src="js/schema.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/queries.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/history.js"></script>
    <script src="js/fileExplorer.js"></script>
    <script src="js/demo.js"></script>
    <script src="js/ollama.js"></script>
    <script src="js/modelManager.js"></script>
    <script src="js/timeSeriesProcessor.js"></script>
    <script src="js/aiAnalytics.js"></script>
    <script src="js/analyticsVisualizer.js"></script>
    <script src="js/analytics.js"></script>
    <script src="js/interface.js"></script>
    <script src="js/app.js"></script>
</body>
</html>