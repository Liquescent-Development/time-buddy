<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafana Query IDE</title>
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/sql-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    
    <!-- Application Styles -->
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <!-- VS Code-like Layout -->
    <div class="vscode-container">
        <!-- Title Bar -->
        <div class="title-bar">
            <div class="title-bar-content">
                <span class="app-name">Grafana Query IDE</span>
                <div class="title-bar-controls">
                    <span class="connection-status disconnected" id="titleBarConnectionStatus">Not Connected</span>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Activity Bar (Left Icons) -->
            <div class="activity-bar">
                <div class="activity-item active" data-view="connections" title="Connections & Data Sources">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
                <div class="activity-item" data-view="explorer" title="Schema Explorer">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 4H4c-1.11 0-2 .89-2 2v3h2V6h4V4zm6 0v2h4v3h2V6c0-1.11-.89-2-2-2h-4zm-6 15v2h4c1.11 0 2-.89 2-2v-3h-2v3H4v-2H2v3c0 1.11.89 2 2 2h4zm8 0h4c1.11 0 2-.89 2-2v-3h-2v3h-4v2z"/>
                    </svg>
                </div>
                <div class="activity-item" data-view="dashboards" title="Dashboard Explorer">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                    </svg>
                </div>
                <div class="activity-item" data-view="files" title="File Explorer">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                    </svg>
                </div>
                <div class="activity-item" data-view="history" title="Query History">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                    </svg>
                </div>
            </div>

            <!-- Main Content Area (everything except activity bar) -->
            <div class="main-content-area">
                <!-- Horizontal Layout (sidebar + editor) -->
                <div class="horizontal-layout">
                    <!-- Side Bar (Changes based on activity selection) -->
                    <div class="sidebar">
                        <div class="sidebar-resizer"></div>
                        <!-- Connections Panel -->
                        <div class="sidebar-panel active" id="connectionsPanel">
                            <div class="sidebar-header">
                                <h3>Connections & Data Sources</h3>
                            </div>
                            <div class="sidebar-content">
                                <!-- Connections Section -->
                                <div class="section-wrapper">
                                    <div class="section-header">
                                        <h4>Connections</h4>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <button class="icon-button" onclick="exportConnections()" title="Export Connections" style="background: transparent; color: #cccccc; border: 1px solid #454545; padding: 4px 8px; border-radius: 3px; cursor: pointer; display: flex; align-items: center;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                                                </svg>
                                            </button>
                                            <button class="icon-button" onclick="importConnections()" title="Import Connections" style="background: transparent; color: #cccccc; border: 1px solid #454545; padding: 4px 8px; border-radius: 3px; cursor: pointer; display: flex; align-items: center;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
                                                </svg>
                                            </button>
                                            <button class="icon-button" onclick="showNewConnectionDialog()" title="New Connection" style="background: #007acc; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; display: flex; align-items: center;">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="section-scrollable">
                                        <div class="connection-list" id="connectionList">
                                            <div class="empty-state">
                                                <div style="margin-bottom: 12px; color: #858585;">No connections configured</div>
                                                <button class="primary-button" onclick="showNewConnectionDialog()" style="font-size: 12px; padding: 6px 12px;">
                                                    Add Your First Connection
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Data Sources Section -->
                                <div class="section-wrapper">
                                    <div class="section-header">
                                        <h4>Data Sources</h4>
                                        <button class="icon-button" onclick="refreshDataSources()" title="Refresh Data Sources">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="section-scrollable">
                                        <div class="datasource-list" id="datasourceList">
                                            <div class="empty-state">Connect to Grafana first</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Schema Explorer Panel -->
                        <div class="sidebar-panel" id="explorerPanel">
                            <div class="sidebar-header">
                                <h3>Schema Explorer</h3>
                                <button class="icon-button" onclick="refreshSchema()" title="Refresh Schema">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="sidebar-content">
                                <div class="datasource-selector-container">
                                    <select id="schemaDatasourceSelect" class="datasource-select" onchange="onSchemaDatasourceChange()">
                                        <option value="">Select a data source</option>
                                    </select>
                                </div>
                                <div id="schemaContainer">
                                    <div class="empty-state">Select a data source to explore schema</div>
                                </div>
                            </div>
                        </div>

                        <!-- Dashboard Explorer Panel -->
                        <div class="sidebar-panel" id="dashboardsPanel">
                            <div class="sidebar-header">
                                <h3>Dashboard Explorer</h3>
                            </div>
                            <div class="sidebar-content">
                                <div class="search-container">
                                    <input type="text" id="dashboardSearch" placeholder="Search dashboards..." class="search-input" onkeyup="searchDashboards()">
                                </div>
                                <div id="dashboardResults" class="dashboard-results">
                                    <div class="empty-state">Search for dashboards to explore</div>
                                </div>
                                <!-- Dashboard Queries Section -->
                                <div id="dashboardQueries" class="dashboard-queries hidden">
                                    <div class="dashboard-info">
                                        <h4 id="selectedDashboardTitle"></h4>
                                        <p id="selectedDashboardDescription"></p>
                                    </div>
                                    <div class="dashboard-query-list">
                                        <div class="dashboard-queries-header">
                                            <span>Queries</span>
                                        </div>
                                        <div id="dashboardQueryList" class="query-list"></div>
                                    </div>
                                    <div id="dashboardQueryPreview" class="query-preview hidden">
                                        <div class="query-preview-header">
                                            <span>Query Preview</span>
                                        </div>
                                        <div id="queryPreviewContent" class="query-preview-content"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- File Explorer Panel -->
                        <div class="sidebar-panel" id="filesPanel">
                            <div class="sidebar-header">
                                <h3>File Explorer</h3>
                                <button class="icon-button" onclick="selectQueryDirectory()" title="Open Folder">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="sidebar-content">
                                <div class="file-explorer-container">
                                    <div id="fileExplorerTree" class="file-tree">
                                        <div class="empty-state">Select a folder to explore query files</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- History Panel -->
                        <div class="sidebar-panel" id="historyPanel">
                            <div class="sidebar-header">
                                <h3>Query History</h3>
                                <button class="icon-button" onclick="clearQueryHistory()" title="Clear History">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="sidebar-content">
                                <div class="search-container">
                                    <input type="text" id="historySearch" placeholder="Search history..." class="search-input" onkeyup="History.handleSearch(this.value)">
                                </div>
                                <div id="historyList" class="history-list">
                                    <div class="empty-state">No query history yet</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Editor and Panel Area -->
                    <div class="editor-panel-area">
                        <!-- Main Editor Area -->
                        <div class="editor-area">
                            <!-- Tab Bar -->
                            <div class="tab-bar" id="tabBar">
                                <div class="tab active" data-tab-id="untitled-1">
                                    <span class="tab-label">Untitled-1</span>
                                    <button class="tab-close" onclick="closeTab('untitled-1')">×</button>
                                </div>
                                <button class="new-tab-button" title="New Query">+</button>
                            </div>

                            <!-- Tab Content -->
                            <div class="tab-content">
                                <div class="editor-container active" data-tab-id="untitled-1">
                                    <!-- Query Options Bar -->
                                    <div class="editor-toolbar">
                                        <div class="editor-options">
                                            <div class="option-group">
                                                <label>Data Source:</label>
                                                <select class="tab-datasource-select" onchange="onTabDatasourceChange()">
                                                    <option value="">Select data source</option>
                                                </select>
                                            </div>
                                            <div class="option-group">
                                                <label>From (hours ago):</label>
                                                <input type="number" id="timeFrom" value="1" min="0" step="0.1" class="small-input">
                                            </div>
                                            <div class="option-group">
                                                <label>To (hours ago):</label>
                                                <input type="number" id="timeTo" value="0" min="0" step="0.1" class="small-input">
                                            </div>
                                            <div class="option-group">
                                                <button class="execute-button" onclick="Interface.executeQuery('untitled-1')" disabled>
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                        <path d="M8 5v14l11-7z"/>
                                                    </svg>
                                                    Execute
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- CodeMirror Editor -->
                                    <div class="code-editor-container">
                                        <textarea id="query" placeholder="Enter your query here..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bottom Panel (Results, Variables, etc.) -->
                        <div class="panel-area">
                    <div class="panel-resizer"></div>
                    <div class="panel-tabs">
                        <div class="panel-tab active" data-panel="results">Results</div>
                        <div class="panel-tab" data-panel="variables">Variables</div>
                        <div class="panel-tab" data-panel="settings">Settings</div>
                        <button class="panel-close" onclick="togglePanel()" title="Close Panel">×</button>
                    </div>

                    <div class="panel-content">
                        <!-- Results Panel -->
                        <div class="panel-section active" id="resultsPanel">
                            <div id="results">
                                <div class="empty-state">No query executed yet</div>
                            </div>
                        </div>

                        <!-- Variables Panel -->
                        <div class="panel-section" id="variablesPanel">
                            <div id="variablesContainer">
                                <div class="empty-state">No variables defined</div>
                            </div>
                        </div>

                        <!-- Settings Panel -->
                        <div class="panel-section" id="settingsPanel">
                            <div class="settings-grid">
                                <div class="setting-group">
                                    <label for="maxDataPoints">Max Data Points</label>
                                    <input type="number" id="maxDataPoints" value="1000" min="1">
                                </div>
                                <div class="setting-group">
                                    <label for="intervalMs">Interval (ms)</label>
                                    <input type="number" id="intervalMs" value="15000" min="1000" step="1000">
                                </div>
                                <div class="setting-group">
                                    <label>
                                        <input type="checkbox" id="instantQuery">
                                        Instant Query (PromQL only)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dialogs -->
    <!-- Connection Dialog -->
    <div class="modal-overlay" id="connectionDialog">
        <div class="modal">
            <div class="modal-header">
                <h3 id="connectionDialogTitle">New Connection</h3>
                <button class="modal-close" onclick="hideConnectionDialog()">×</button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label for="connectionName">Connection Name</label>
                    <input type="text" id="connectionName" placeholder="My Grafana Server">
                </div>
                <div class="form-group">
                    <label for="connectionUrl">Grafana URL</label>
                    <input type="text" id="connectionUrl" placeholder="https://grafana.example.com">
                </div>
                <div class="form-group">
                    <label for="connectionUsername">Username</label>
                    <input type="text" id="connectionUsername" placeholder="admin">
                </div>
                <div class="form-group">
                    <label for="connectionPassword">Password</label>
                    <input type="password" id="connectionPassword" placeholder="Enter password">
                </div>
                
                <!-- SOCKS5 Proxy Section -->
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableProxy" onchange="toggleProxyFields()"> Use SOCKS5 Proxy
                    </label>
                </div>
                
                <div id="proxyFields" class="proxy-fields" style="display: none;">
                    <div class="form-group">
                        <label for="proxyHost">Proxy Host</label>
                        <input type="text" id="proxyHost" placeholder="127.0.0.1">
                    </div>
                    <div class="form-group">
                        <label for="proxyPort">Proxy Port</label>
                        <input type="number" id="proxyPort" placeholder="1080" min="1" max="65535">
                    </div>
                    <div class="form-group">
                        <label for="proxyUsername">Proxy Username (optional)</label>
                        <input type="text" id="proxyUsername" placeholder="proxy_user">
                    </div>
                    <div class="form-group">
                        <label for="proxyPassword">Proxy Password (optional)</label>
                        <input type="password" id="proxyPassword" placeholder="proxy_password">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="saveConnection()" class="primary-button">Save & Connect</button>
                <button onclick="hideConnectionDialog()" class="secondary-button">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Auth Status -->
    <div id="authStatus" class="auth-status-toast"></div>

    <!-- Application Scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/api.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/connections.js"></script>
    <script src="js/variables.js"></script>
    <script src="js/schema.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/queries.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/history.js"></script>
    <script src="js/fileExplorer.js"></script>
    <script src="js/interface.js"></script>
    <script src="js/app.js"></script>
</body>
</html>